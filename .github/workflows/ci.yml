name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  test:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: PowerShell version
        shell: pwsh
        run: $PSVersionTable.PSVersion

      - name: Install Pester v5
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module Pester -Force -Scope CurrentUser -SkipPublisherCheck -MinimumVersion 5.0.0
          Import-Module Pester -Force

      - name: Run Pester Tests
        shell: pwsh
        run: |
          Import-Module ./src/ps/Bottleneck.psm1 -Force -WarningAction SilentlyContinue
          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.Run.Exit = $true
          $config.Output.Verbosity = 'Detailed'
          Invoke-Pester -Configuration $config

      - name: Upload Reports Artifact (if any)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: Reports/**/*.html
          if-no-files-found: ignore
